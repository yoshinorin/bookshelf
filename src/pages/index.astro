---
import Layout from '../layouts/Layout.astro';
import Toolbar from '../components/Toolbar.astro';
import Footer from '../components/Footer.astro';
import { config } from '../config';

const bookCountText = config.ui.labels.bookCount.replace('{count}', '<span id="book-count">0</span>');
---

<Layout title={config.site.name}>
  <Toolbar />
  <main class="container">
    <div class="alert-info">
      {config.ui.alertMessage}
    </div>

    <div class="form-row">
      <div class="form-group">
        <select id="select-year" aria-label={config.ui.labels.year}>
          <option value="">{config.ui.labels.year}</option>
        </select>
      </div>
      <div class="form-group">
        <input type="text" id="search-title" placeholder={config.ui.labels.title} aria-label={config.ui.labels.title} />
      </div>
      <div class="form-group">
        <select id="select-genre" aria-label={config.ui.labels.genre}>
          <option value="">{config.ui.labels.genre}</option>
        </select>
      </div>
    </div>

    <div class="book-count" set:html={bookCountText} />

    <div class="book-grid" id="book-grid">
      <!-- Books will be loaded here -->
    </div>

    <button class="btn btn-more" id="load-more" style="display: none;">
      {config.ui.labels.loadMore}
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M7 10l5 5 5-5z"/>
      </svg>
    </button>
  </main>
  <div class="divider"></div>
  <Footer />
</Layout>

<script define:vars={{ config }}>
  window.__CONFIG__ = config;
</script>

<script>
  import type { IBook } from '../types/book';

  const config = (window as any).__CONFIG__;
  const PER_PAGE = config.pagination.perPage;
  let books: IBook[] = [];
  let filteredBooks: IBook[] = [];
  let currentPage = 1;
  let genres: string[] = [];

  const bookGrid = document.getElementById('book-grid');
  const bookCount = document.getElementById('book-count');
  const loadMore = document.getElementById('load-more') as HTMLButtonElement;
  const selectYear = document.getElementById('select-year') as HTMLSelectElement;
  const searchTitle = document.getElementById('search-title') as HTMLInputElement;
  const selectGenre = document.getElementById('select-genre') as HTMLSelectElement;

  async function loadBooks() {
    try {
      const response = await fetch(config.data.booksPath);
      books = await response.json();

      const years = [...new Set(books.map(b => new Date(b.readAt).getFullYear()))].sort((a, b) => b - a);
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year.toString();
        option.textContent = year.toString();
        selectYear.appendChild(option);
      });

      genres = [...new Set(books.map(b => b.genre))].sort((a, b) => b.localeCompare(a));
      genres.forEach(genre => {
        const option = document.createElement('option');
        option.value = genre;
        option.textContent = genre;
        selectGenre.appendChild(option);
      });

      filterAndRender();
    } catch (error) {
      console.error('Failed to load books:', error);
    }
  }

  function getBookImage(book: IBook): string {
    if (book.imageUrl) return book.imageUrl;
    if (book.asin) return config.amazon.imageUrlTemplate.replace('{asin}', book.asin);
    return '';
  }

  function getProductUrl(book: IBook): string {
    if (book.productUrl) return book.productUrl;
    if (book.asin) return config.amazon.productUrlTemplate.replace('{asin}', book.asin);
    return '#';
  }

  function filterBooks(): IBook[] {
    let result = [...books];

    const year = selectYear.value;
    const title = searchTitle.value.toLowerCase();
    const genre = selectGenre.value;

    if (year) {
      result = result.filter(book => {
        const bookYear = new Date(book.readAt).getFullYear().toString();
        return bookYear === year;
      });
    }

    if (title) {
      result = result.filter(book => book.title.toLowerCase().includes(title));
    }

    if (genre) {
      result = result.filter(book => book.genre === genre);
    }

    return result;
  }

  function renderBooks(append = false) {
    if (!bookGrid) return;

    const start = append ? (currentPage - 1) * PER_PAGE : 0;
    const booksToShow = filteredBooks.slice(start, currentPage * PER_PAGE);
    const html = booksToShow.map((book, i) => `
      <a href="${getProductUrl(book)}" target="_blank" rel="noopener" class="book-item" title="${book.title}" style="animation-delay: ${Math.min(i * 0.04, 0.6)}s">
        <img src="${getBookImage(book)}" alt="${book.title}" loading="lazy" />
      </a>
    `).join('');

    if (append) {
      bookGrid.insertAdjacentHTML('beforeend', html);
    } else {
      bookGrid.innerHTML = html;
    }

    if (bookCount) {
      bookCount.textContent = filteredBooks.length.toString();
    }

    if (loadMore) {
      loadMore.style.display = currentPage * PER_PAGE < filteredBooks.length ? 'inline-flex' : 'none';
    }
  }

  function filterAndRender() {
    currentPage = 1;
    filteredBooks = filterBooks();
    renderBooks();
  }

  function updateSelectStyle(el: HTMLSelectElement) {
    el.classList.toggle('placeholder', el.value === '');
  }

  selectYear.addEventListener('change', () => { updateSelectStyle(selectYear); filterAndRender(); });
  searchTitle.addEventListener('input', filterAndRender);
  selectGenre.addEventListener('change', () => { updateSelectStyle(selectGenre); filterAndRender(); });

  updateSelectStyle(selectYear);
  updateSelectStyle(selectGenre);

  loadMore.addEventListener('click', () => {
    currentPage++;
    renderBooks(true);
  });

  loadBooks();
</script>
